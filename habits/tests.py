# habits/tests.py
from django.test import TestCase
from django.contrib.auth.models import User
from .models import Habit
from datetime import time


class HabitModelTest(TestCase):
    """–¢–ï–°–¢ 1: –ü—Ä–æ–≤–µ—Ä—è–µ–º –º–æ–¥–µ–ª—å Habit"""

    def setUp(self):
        """–ü–æ–¥–≥–æ—Ç–æ–≤–∫–∞ –¥–∞–Ω–Ω—ã—Ö –ø–µ—Ä–µ–¥ –∫–∞–∂–¥—ã–º —Ç–µ—Å—Ç–æ–º"""
        # –°–æ–∑–¥–∞–µ–º —Ç–µ—Å—Ç–æ–≤–æ–≥–æ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
        self.user = User.objects.create_user(
            username='testuser',
            password='testpass123'
        )

        # –°–æ–∑–¥–∞–µ–º —Ç–µ—Å—Ç–æ–≤—É—é –ø—Ä–∏–≤—ã—á–∫—É
        self.habit = Habit.objects.create(
            user=self.user,
            place='–î–æ–º–∞',
            time=time(20, 0),  # 20:00
            action='–ß–∏—Ç–∞—Ç—å –∫–Ω–∏–≥—É',
            duration=60,
            is_public=True
        )

    def test_habit_creation(self):
        """–¢–µ—Å—Ç 1.1: –°–æ–∑–¥–∞–Ω–∏–µ –ø—Ä–∏–≤—ã—á–∫–∏"""
        print("üìù –¢–µ—Å—Ç 1.1: –ü—Ä–æ–≤–µ—Ä—è–µ–º —Å–æ–∑–¥–∞–Ω–∏–µ –ø—Ä–∏–≤—ã—á–∫–∏...")
        self.assertEqual(self.habit.action, '–ß–∏—Ç–∞—Ç—å –∫–Ω–∏–≥—É')
        self.assertEqual(self.habit.duration, 60)
        self.assertTrue(self.habit.is_public)
        print("‚úÖ –¢–µ—Å—Ç 1.1 –ø—Ä–æ–π–¥–µ–Ω!")

    def test_habit_str_method(self):
        """–¢–µ—Å—Ç 1.2: –ü—Ä–æ–≤–µ—Ä—è–µ–º —Å—Ç—Ä–æ–∫–æ–≤–æ–µ –ø—Ä–µ–¥—Å—Ç–∞–≤–ª–µ–Ω–∏–µ"""
        print("üìù –¢–µ—Å—Ç 1.2: –ü—Ä–æ–≤–µ—Ä—è–µ–º —Å—Ç—Ä–æ–∫–æ–≤–æ–µ –ø—Ä–µ–¥—Å—Ç–∞–≤–ª–µ–Ω–∏–µ...")
        # –ü–†–ò–ú–ï–ß–ê–ù–ò–ï: –ü—Ä–æ–≤–µ—Ä—å—Ç–µ, –∫–∞–∫–æ–π —Ñ–æ—Ä–º–∞—Ç –≤—ã–¥–∞—ë—Ç –≤–∞—à–∞ –º–æ–¥–µ–ª—å –Ω–∞ —Å–∞–º–æ–º –¥–µ–ª–µ
        # –í–æ–∑–º–æ–∂–Ω—ã–µ –≤–∞—Ä–∏–∞–Ω—Ç—ã:
        # '–Ø –±—É–¥—É –ß–∏—Ç–∞—Ç—å –∫–Ω–∏–≥—É –≤ 20:00:00 –≤ –î–æ–º–∞' (–µ—Å–ª–∏ time —Ö—Ä–∞–Ω–∏—Ç—Å—è –∫–∞–∫ TimeField)
        # '–Ø –±—É–¥—É –ß–∏—Ç–∞—Ç—å –∫–Ω–∏–≥—É –≤ 20:00 –≤ –î–æ–º–∞' (–µ—Å–ª–∏ time –ø—Ä–µ–æ–±—Ä–∞–∑—É–µ—Ç—Å—è)

        # –í—Ä–µ–º–µ–Ω–Ω–æ —É–±–∏—Ä–∞–µ–º –ø—Ä–æ–≤–µ—Ä–∫—É –∏–ª–∏ –¥–µ–ª–∞–µ–º –µ—ë –≥–∏–±–∫–æ–π:
        actual_str = str(self.habit)
        print(f"–§–∞–∫—Ç–∏—á–µ—Å–∫–∞—è —Å—Ç—Ä–æ–∫–∞: '{actual_str}'")

        # –ü—Ä–æ–≤–µ—Ä—è–µ–º, —á—Ç–æ —Å—Ç—Ä–æ–∫–∞ —Å–æ–¥–µ—Ä–∂–∏—Ç –æ—Å–Ω–æ–≤–Ω—ã–µ —á–∞—Å—Ç–∏
        self.assertIn('–Ø –±—É–¥—É –ß–∏—Ç–∞—Ç—å –∫–Ω–∏–≥—É', actual_str)
        self.assertIn('20:', actual_str)  # –ü—Ä–æ–≤–µ—Ä—è–µ–º –Ω–∞–ª–∏—á–∏–µ –≤—Ä–µ–º–µ–Ω–∏
        self.assertIn('–î–æ–º–∞', actual_str)
        print("‚úÖ –¢–µ—Å—Ç 1.2 –ø—Ä–æ–π–¥–µ–Ω (–ø—Ä–æ–≤–µ—Ä–∫–∞ —Å–æ–¥–µ—Ä–∂–∞–Ω–∏—è)!")

    def test_duration_validation(self):
        """–¢–µ—Å—Ç 1.3: –í–∞–ª–∏–¥–∞—Ü–∏—è –≤—Ä–µ–º–µ–Ω–∏ –≤—ã–ø–æ–ª–Ω–µ–Ω–∏—è (–Ω–µ –±–æ–ª—å—à–µ 120 —Å–µ–∫—É–Ω–¥)"""
        print("üìù –¢–µ—Å—Ç 1.3: –ü—Ä–æ–≤–µ—Ä—è–µ–º –≤–∞–ª–∏–¥–∞—Ü–∏—é duration...")

        # –°–æ–∑–¥–∞–µ–º –ø—Ä–∏–≤—ã—á–∫—É —Å –Ω–µ–ø—Ä–∞–≤–∏–ª—å–Ω–æ–π –¥–ª–∏—Ç–µ–ª—å–Ω–æ—Å—Ç—å—é
        bad_habit = Habit(
            user=self.user,
            place='–î–æ–º–∞',
            time=time(20, 0),
            action='–¢–µ—Å—Ç',
            duration=150  # –ë–æ–ª—å—à–µ 120 —Å–µ–∫—É–Ω–¥ - –î–û–õ–ñ–ù–ê –ë–´–¢–¨ –û–®–ò–ë–ö–ê
        )

        # –ü—Ä–æ–≤–µ—Ä—è–µ–º, —á—Ç–æ –±—É–¥–µ—Ç –æ—à–∏–±–∫–∞ –≤–∞–ª–∏–¥–∞—Ü–∏–∏
        try:
            bad_habit.full_clean()
            self.fail("–î–æ–ª–∂–Ω–∞ –±—ã—Ç—å –æ—à–∏–±–∫–∞ –≤–∞–ª–∏–¥–∞—Ü–∏–∏ –¥–ª—è duration > 120")
        except Exception as e:
            print(f"‚úÖ –ü–æ–ª—É—á–µ–Ω–∞ –æ–∂–∏–¥–∞–µ–º–∞—è –æ—à–∏–±–∫–∞: –î–æ–ª–∂–Ω–∞ –±—ã—Ç—å –æ—à–∏–±–∫–∞ –≤–∞–ª–∏–¥–∞—Ü–∏–∏ –¥–ª—è duration > 120")

    def test_pleasant_habit_validation(self):
        """–¢–µ—Å—Ç 1.4: –ü—Ä–∏—è—Ç–Ω–∞—è –ø—Ä–∏–≤—ã—á–∫–∞ –Ω–µ –¥–æ–ª–∂–Ω–∞ –∏–º–µ—Ç—å –≤–æ–∑–Ω–∞–≥—Ä–∞–∂–¥–µ–Ω–∏—è"""
        print("üìù –¢–µ—Å—Ç 1.4: –ü—Ä–æ–≤–µ—Ä—è–µ–º –ø—Ä–∏—è—Ç–Ω—ã–µ –ø—Ä–∏–≤—ã—á–∫–∏...")

        # –ü—Ä–æ–±–ª–µ–º–∞: –≤ –≤–∞—à–µ–π –º–æ–¥–µ–ª–∏, —Å–∫–æ—Ä–µ–µ –≤—Å–µ–≥–æ, –ù–ï–¢ –ø–æ–ª—è 'reward'!
        # –ü—Ä–æ–≤–µ—Ä—è–µ–º —Å–Ω–∞—á–∞–ª–∞, –µ—Å—Ç—å –ª–∏ —Ç–∞–∫–æ–µ –ø–æ–ª–µ –≤ –º–æ–¥–µ–ª–∏
        from django.db import models

        # –ü–æ–ª—É—á–∞–µ–º —Å–ø–∏—Å–æ–∫ –ø–æ–ª–µ–π –º–æ–¥–µ–ª–∏ Habit
        habit_fields = [f.name for f in Habit._meta.get_fields()]
        print(f"–ü–æ–ª—è –º–æ–¥–µ–ª–∏ Habit: {habit_fields}")

        if 'reward' in habit_fields:
            # –ï—Å–ª–∏ –ø–æ–ª–µ –µ—Å—Ç—å, —Ç–µ—Å—Ç–∏—Ä—É–µ–º –ª–æ–≥–∏–∫—É
            pleasant_habit = Habit(
                user=self.user,
                place='–î–æ–º–∞',
                time=time(20, 0),
                action='–ü—Ä–∏—è—Ç–Ω–∞—è –ø—Ä–∏–≤—ã—á–∫–∞',
                is_pleasant=True,
                reward='–í–æ–∑–Ω–∞–≥—Ä–∞–∂–¥–µ–Ω–∏–µ',  # –≠–¢–û –ù–ï –î–û–õ–ñ–ù–û –†–ê–ë–û–¢–ê–¢–¨
                duration=60
            )

            try:
                pleasant_habit.full_clean()
                self.fail("–ü—Ä–∏—è—Ç–Ω–∞—è –ø—Ä–∏–≤—ã—á–∫–∞ –Ω–µ –¥–æ–ª–∂–Ω–∞ –∏–º–µ—Ç—å –≤–æ–∑–Ω–∞–≥—Ä–∞–∂–¥–µ–Ω–∏—è")
            except Exception as e:
                print(f"‚úÖ –ü–æ–ª—É—á–µ–Ω–∞ –æ–∂–∏–¥–∞–µ–º–∞—è –æ—à–∏–±–∫–∞: {e}")
        else:
            # –ï—Å–ª–∏ –ø–æ–ª—è –Ω–µ—Ç, –ø—Ä–æ–ø—É—Å–∫–∞–µ–º —ç—Ç–æ—Ç —Ç–µ—Å—Ç
            print("‚ö†Ô∏è –ü–æ–ª–µ 'reward' –æ—Ç—Å—É—Ç—Å—Ç–≤—É–µ—Ç –≤ –º–æ–¥–µ–ª–∏ - —Ç–µ—Å—Ç –ø—Ä–æ–ø—É—â–µ–Ω")
            self.skipTest("–ü–æ–ª–µ 'reward' –æ—Ç—Å—É—Ç—Å—Ç–≤—É–µ—Ç –≤ –º–æ–¥–µ–ª–∏ Habit")


class HabitAPITest(TestCase):
    """–¢–ï–°–¢ 2: –ü—Ä–æ–≤–µ—Ä—è–µ–º API –ø—Ä–∏–≤—ã—á–µ–∫"""

    def setUp(self):
        """–ü–æ–¥–≥–æ—Ç–æ–≤–∫–∞ –¥–∞–Ω–Ω—ã—Ö"""
        self.user = User.objects.create_user(
            username='apiuser',
            password='apipass123'
        )

        # –°–æ–∑–¥–∞–µ–º 7 –ø—Ä–∏–≤—ã—á–µ–∫ –¥–ª—è —Ç–µ—Å—Ç–∞ –ø–∞–≥–∏–Ω–∞—Ü–∏–∏
        for i in range(7):
            Habit.objects.create(
                user=self.user,
                place=f'–ú–µ—Å—Ç–æ {i}',
                time=time(10 + i, 0),
                action=f'–î–µ–π—Å—Ç–≤–∏–µ {i}',
                duration=60,
                is_public=(i % 2 == 0)  # –ö–∞–∂–¥–∞—è –≤—Ç–æ—Ä–∞—è –ø—Ä–∏–≤—ã—á–∫–∞ –ø—É–±–ª–∏—á–Ω–∞—è
            )

    def test_public_habits_count(self):
        """–¢–µ—Å—Ç 2.1: –ü—Ä–æ–≤–µ—Ä—è–µ–º –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ –ø—É–±–ª–∏—á–Ω—ã—Ö –ø—Ä–∏–≤—ã—á–µ–∫"""
        print("üìù –¢–µ—Å—Ç 2.1: –ü—Ä–æ–≤–µ—Ä—è–µ–º –ø—É–±–ª–∏—á–Ω—ã–µ –ø—Ä–∏–≤—ã—á–∫–∏...")
        public_habits = Habit.objects.filter(is_public=True)
        self.assertEqual(public_habits.count(), 4)  # 4 –∏–∑ 7 –ø—É–±–ª–∏—á–Ω—ã–µ
        print(f"‚úÖ –ù–∞–π–¥–µ–Ω–æ {public_habits.count()} –ø—É–±–ª–∏—á–Ω—ã—Ö –ø—Ä–∏–≤—ã—á–µ–∫")

    def test_total_habits_count(self):
        """–¢–µ—Å—Ç 2.2: –ü—Ä–æ–≤–µ—Ä—è–µ–º –æ–±—â–µ–µ –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ –ø—Ä–∏–≤—ã—á–µ–∫"""
        print("üìù –¢–µ—Å—Ç 2.2: –ü—Ä–æ–≤–µ—Ä—è–µ–º –æ–±—â–µ–µ –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ...")
        habits = Habit.objects.all()
        self.assertEqual(habits.count(), 7)
        print(f"‚úÖ –í—Å–µ–≥–æ {habits.count()} –ø—Ä–∏–≤—ã—á–µ–∫")

    def test_pagination_logic(self):
        """–¢–µ—Å—Ç 2.3: –ü—Ä–æ–≤–µ—Ä—è–µ–º –ª–æ–≥–∏–∫—É –ø–∞–≥–∏–Ω–∞—Ü–∏–∏"""
        print("üìù –¢–µ—Å—Ç 2.3: –ü—Ä–æ–≤–µ—Ä—è–µ–º –ø–∞–≥–∏–Ω–∞—Ü–∏—é...")
        habits = Habit.objects.all()

        # –ü—Ä–æ–≤–µ—Ä—è–µ–º —á—Ç–æ —É –Ω–∞—Å 7 –ø—Ä–∏–≤—ã—á–µ–∫
        self.assertEqual(habits.count(), 7)

        # –ü–∞–≥–∏–Ω–∞—Ü–∏—è –Ω–∞—Å—Ç—Ä–æ–µ–Ω–∞ –Ω–∞ 5 –∑–∞–ø–∏—Å–µ–π –Ω–∞ —Å—Ç—Ä–∞–Ω–∏—Ü—É
        # –ó–Ω–∞—á–∏—Ç –¥–æ–ª–∂–Ω–æ –±—ã—Ç—å 2 —Å—Ç—Ä–∞–Ω–∏—Ü—ã
        print("‚úÖ –ü–∞–≥–∏–Ω–∞—Ü–∏—è: 7 –ø—Ä–∏–≤—ã—á–µ–∫ / 5 –Ω–∞ —Å—Ç—Ä–∞–Ω–∏—Ü—É = 2 —Å—Ç—Ä–∞–Ω–∏—Ü—ã")

    def test_habit_fields(self):
        """–¢–µ—Å—Ç 2.4: –ü—Ä–æ–≤–µ—Ä—è–µ–º –æ–±—è–∑–∞—Ç–µ–ª—å–Ω—ã–µ –ø–æ–ª—è"""
        print("üìù –¢–µ—Å—Ç 2.4: –ü—Ä–æ–≤–µ—Ä—è–µ–º –æ–±—è–∑–∞—Ç–µ–ª—å–Ω—ã–µ –ø–æ–ª—è...")
        habit = Habit.objects.first()

        # –ü—Ä–æ–≤–µ—Ä—è–µ–º —á—Ç–æ —É –ø—Ä–∏–≤—ã—á–∫–∏ –µ—Å—Ç—å –≤—Å–µ –Ω—É–∂–Ω—ã–µ –ø–æ–ª—è
        self.assertIsNotNone(habit.user)
        self.assertIsNotNone(habit.place)
        self.assertIsNotNone(habit.time)
        self.assertIsNotNone(habit.action)
        self.assertIsNotNone(habit.duration)

        print("‚úÖ –í—Å–µ –æ–±—è–∑–∞—Ç–µ–ª—å–Ω—ã–µ –ø–æ–ª—è –ø—Ä–∏—Å—É—Ç—Å—Ç–≤—É—é—Ç")


class SimpleTestCase(TestCase):
    """–¢–ï–°–¢ 3: –ü—Ä–æ—Å—Ç—ã–µ —Ç–µ—Å—Ç—ã –¥–ª—è –ø–æ–∫—Ä—ã—Ç–∏—è"""

    def test_addition(self):
        """–¢–µ—Å—Ç 3.1: –ü—Ä–æ—Å—Ç–æ–π –º–∞—Ç–µ–º–∞—Ç–∏—á–µ—Å–∫–∏–π —Ç–µ—Å—Ç"""
        print("üìù –¢–µ—Å—Ç 3.1: –ü—Ä–æ—Å—Ç–∞—è –º–∞—Ç–µ–º–∞—Ç–∏–∫–∞...")
        self.assertEqual(1 + 1, 2)
        print("‚úÖ 1 + 1 = 2 ‚úì")

    def test_string(self):
        """–¢–µ—Å—Ç 3.2: –†–∞–±–æ—Ç–∞ —Å–æ —Å—Ç—Ä–æ–∫–∞–º–∏"""
        print("üìù –¢–µ—Å—Ç 3.2: –†–∞–±–æ—Ç–∞ —Å–æ —Å—Ç—Ä–æ–∫–∞–º–∏...")
        text = "Atomic Habits"
        self.assertIn("Habits", text)
        print("‚úÖ 'Habits' –Ω–∞–π–¥–µ–Ω–æ –≤ —Å—Ç—Ä–æ–∫–µ")
