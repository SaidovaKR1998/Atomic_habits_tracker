name: Django CI/CD Pipeline


on:
  push:
    branches: [main, develop]
  pull_request:
    branches: [main]

jobs:
  test:
    runs-on: ubuntu-latest

    services:
      postgres:
        image: postgres:15-alpine
        env:
          POSTGRES_DB: habits_db
          POSTGRES_USER: habits_user
          POSTGRES_PASSWORD: Said43Said43
        options: >-
          --health-cmd pg_isready
          --health-interval 10s
          --health-timeout 5s
          --health-retries 5
        ports:
          - 5432:5432

      redis:
        image: redis:7-alpine
        options: >-
          --health-cmd "redis-cli ping"
          --health-interval 10s
          --health-timeout 5s
          --health-retries 5
        ports:
          - 6379:6379

    steps:
    - uses: actions/checkout@v4

    - name: Set up Python
      uses: actions/setup-python@v5
      with:
        python-version: '3.11'

    - name: Install dependencies
      run: |
        python -m pip install --upgrade pip
        pip install -r requirements.txt

    - name: Run migrations
      env:
        POSTGRES_DB: habits_db
        POSTGRES_USER: habits_user
        POSTGRES_PASSWORD: Said43Said43
        POSTGRES_HOST: localhost
        POSTGRES_PORT: 5432
        REDIS_URL: redis://localhost:6379/0
      run: |
        python manage.py migrate

    - name: Run tests
      env:
        POSTGRES_DB: habits_db
        POSTGRES_USER: habits_user
        POSTGRES_PASSWORD: Said43Said43
        POSTGRES_HOST: localhost
        POSTGRES_PORT: 5432
        REDIS_URL: redis://localhost:6379/0
        SECRET_KEY: test-secret-key-for-ci
      run: |
        python manage.py test

  deploy:
    needs: test
    runs-on: ubuntu-latest
    # –ó–∞–ø—É—Å–∫–∞–µ–º –¥–µ–ø–ª–æ–π —Ç–æ–ª—å–∫–æ –ø—Ä–∏ –ø—É—à–µ –≤ main –≤–µ—Ç–∫—É
    if: github.ref == 'refs/heads/main'

    steps:
    - name: Deploy to Server
      uses: appleboy/ssh-action@v1.0.3
      with:
        host: ${{ secrets.SERVER_HOST }}
        username: ${{ secrets.SERVER_USER }}
        key: ${{ secrets.SSH_PRIVATE_KEY }}
        script: |
          echo "üöÄ Starting deployment on $(date)"
          echo "üìÅ Working directory: ~/apps/atomic-habits"
          
          # –ü–µ—Ä–µ—Ö–æ–¥–∏–º –≤ –ø–∞–ø–∫—É –ø—Ä–æ–µ–∫—Ç–∞
          cd ~/apps/atomic-habits
          
          # –ü–æ–ª—É—á–∞–µ–º –ø–æ—Å–ª–µ–¥–Ω–∏–µ –∏–∑–º–µ–Ω–µ–Ω–∏—è –∏–∑ GitHub
          echo "üì• Pulling latest changes from GitHub..."
          git pull origin main
          
          # –û—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º —Å—Ç–∞—Ä—ã–µ –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä—ã (–µ—Å–ª–∏ –µ—Å—Ç—å)
          echo "‚èπÔ∏è Stopping old containers..."
          docker-compose -f docker-compose.prod.yaml down || true
          
          # –°–æ–±–∏—Ä–∞–µ–º –∏ –∑–∞–ø—É—Å–∫–∞–µ–º –Ω–æ–≤—ã–µ –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä—ã
          echo "üî® Building and starting new containers..."
          docker-compose -f docker-compose.prod.yaml up -d --build
          
          # –ñ–¥—ë–º –Ω–µ–º–Ω–æ–≥–æ, —á—Ç–æ–±—ã –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä—ã —É—Å–ø–µ–ª–∏ –∑–∞–ø—É—Å—Ç–∏—Ç—å—Å—è
          echo "‚è≥ Waiting for containers to start..."
          sleep 15
          
          # –í—ã–ø–æ–ª–Ω—è–µ–º –º–∏–≥—Ä–∞—Ü–∏–∏
          echo "üìä Running database migrations..."
          docker-compose -f docker-compose.prod.yaml exec -T backend python manage.py migrate --noinput
          
          # –°–æ–±–∏—Ä–∞–µ–º —Å—Ç–∞—Ç–∏–∫—É
          echo "üì¶ Collecting static files..."
          docker-compose -f docker-compose.prod.yaml exec -T backend python manage.py collectstatic --noinput
          
          # –ü—Ä–æ–≤–µ—Ä—è–µ–º, —á—Ç–æ –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä—ã –∑–∞–ø—É—â–µ–Ω—ã
          echo "üîç Checking container status..."
          docker-compose -f docker-compose.prod.yaml ps
          
          echo "‚úÖ Deployment completed successfully!"
          echo "üåê Your application is now running at: http://${{ secrets.SERVER_HOST }}:8000"
